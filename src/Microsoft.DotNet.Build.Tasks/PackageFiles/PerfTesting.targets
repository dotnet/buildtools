<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Perf Analysis NuGet package paths -->
  <PropertyGroup>
    <TraceEventPackage>Microsoft.Diagnostics.Tracing.TraceEvent\$(TraceEventPackageVersion)</TraceEventPackage>
  </PropertyGroup>

  <ItemGroup>
    <TraceEventNativePath Include="$(PackagesDir)\$(TraceEventPackage)\lib\native\**\*.*" />
  </ItemGroup>

  <Target Name ="PublishPerfRunner" Condition="'$(Performance)'=='true'" BeforeTargets="RunTestsForProject">
    <Copy SourceFiles="@(TraceEventNativePath)" DestinationFiles="@(TraceEventNativePath->'$(StartWorkingDirectory)\%(RecursiveDir)%(Filename)%(Extension)')" />
  </Target>

  <PropertyGroup Condition="'$(TargetOS)'=='Linux'">
    <PerfTestCommandDotnetExecutable>$RUNTIME_PATH/dotnet</PerfTestCommandDotnetExecutable>
    <BenchviewDir>$(ToolsDir)Microsoft.BenchView.JSONFormat/tools</BenchviewDir>
  </PropertyGroup>

  <PropertyGroup Condition="'$(TargetOS)'=='Windows_NT'">
    <PerfTestCommandDotnetExecutable>%RUNTIME_PATH%\dotnet.exe</PerfTestCommandDotnetExecutable>
    <BenchviewDir>$(ToolsDir)Microsoft.BenchView.JSONFormat\tools</BenchviewDir>
  </PropertyGroup>

  <PropertyGroup>
    <PerformanceType Condition="'$(PerformanceType)'==''">Profile</PerformanceType>
  </PropertyGroup>

  <PropertyGroup Condition="'$(PerformanceType)'=='Profile'">
    <RunId>Perf-Profile</RunId>
    <CollectFlags>default+gcapi</CollectFlags>
  </PropertyGroup>

  <PropertyGroup Condition="'$(PerformanceType)'=='Diagnostic'">
    <RunId>Perf-Diagnostic</RunId>
    <CollectFlags>default+BranchMispredictions+CacheMisses+InstructionRetired+gcapi</CollectFlags>
  </PropertyGroup>

  <PropertyGroup Condition="'$(TargetOS)'=='Windows_NT'">
    <PythonCommand>py.exe</PythonCommand>
    <CliExitErrorCommand>EXIT /B 1</CliExitErrorCommand>
  </PropertyGroup>

  <PropertyGroup Condition="'$(TargetOS)'=='Linux'">
    <PythonCommand>python3.5</PythonCommand>
    <CliExitErrorCommand>exit 1</CliExitErrorCommand>
  </PropertyGroup>

  <!-- TODO: Attempt to fail if PerformanceType is unknnown. -->
  <PropertyGroup>
    <PerfTestCommand>$(PerfTestCommandDotnetExecutable) PerfRunner.exe --perf:runid $(RunId) --perf:collect $(CollectFlags) || $(CliExitErrorCommand)</PerfTestCommand>
    <MeasurementPyCommand>$(PythonCommand) $([System.IO.Path]::Combine($(BenchviewDir), "measurement.py")) xunit "$(RunId)-$(AssemblyName).xml" --better desc --drop-first-value --append -o "$(ProjectDir)measurement.json"</MeasurementPyCommand>
  </PropertyGroup>

  <ItemGroup>
    <PerfTestCommandLines Include="$(PerfTestCommand)" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetOS)'=='Windows_NT' and '$(LogToBenchview)' == 'true'">
    <PerfTestCommandLines Include="if exist &quot;$(RunId)-$(AssemblyName).xml&quot; (" />
    <PerfTestCommandLines Include="$(MeasurementPyCommand) || $(CliExitErrorCommand)" />
    <PerfTestCommandLines Include=")" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetOS)'=='Linux' and '$(LogToBenchview)' == 'true'">
    <PerfTestCommandLines Include="if [ -a &quot;$(RunId)-$(AssemblyName).xml&quot; ]; then" />
    <PerfTestCommandLines Include="$(MeasurementPyCommand) || $(CliExitErrorCommand)" />
    <PerfTestCommandLines Include="fi" />
  </ItemGroup>

  <!-- Optimizations to configure Xunit for performance -->
  <ItemGroup Condition="'$(IncludePerformanceTests)' == 'true'">
    <AssemblyInfoUsings Include="using Microsoft.Xunit.Performance%3B" />
    <AssemblyInfoLines Include="[assembly:OptimizeForBenchmarks]" />
  </ItemGroup>

  <PropertyGroup>
    <SubmissionPyCommand>$(PythonCommand) $([System.IO.Path]::Combine($(BenchviewDir), "submission.py")) "$(ProjectDir)measurement.json" --build "$(ProjectDir)build.json" --machine-data "$(ProjectDir)machinedata.json" --metadata "$(ProjectDir)submission-metadata.json" --group "CoreFx" --type "$(BenchviewRuntype)" --config-name "$(ConfigurationGroup)" --config Configuration "$(ConfigurationGroup)" --config OS "$(TargetOS)" --config "RunType" "$(PerformanceType)" -arch "$(Platform)" --machinepool "PerfSnake" -o "$(ProjectDir)submission.json"</SubmissionPyCommand>
    <UploadPyCommand>$(PythonCommand) $([System.IO.Path]::Combine($(BenchviewDir), "upload.py")) "$(ProjectDir)submission.json" --container corefx</UploadPyCommand>
  </PropertyGroup>

  <Target Name="UploadToBenchview" Condition="'$(LogToBenchview)' == 'true'" AfterTargets="TestAllProjects">
    <ItemGroup>
      <BenchviewCalls Include="echo $(SubmissionPyCommand)"/>
      <BenchviewCalls Include="$(SubmissionPyCommand) || $(CliExitErrorCommand)"/>

      <BenchviewCalls Include="echo $(UploadPyCommand)"/>
      <BenchviewCalls Include="$(UploadPyCommand) || $(CliExitErrorCommand)"/>
    </ItemGroup>

    <Exec Command="%(BenchviewCalls.Identity)"/>
  </Target>

  <Target Name="WarnForDebugPerfConfiguration"
          BeforeTargets="RunTestsForProject"
          Condition="'$(Performance)' == 'true' and !$(ConfigurationGroup.ToLower().Contains('release'))">
    <Warning Text="You are running performance tests in a configuration other than Release. Your results may be unreliable." />
  </Target>
</Project>