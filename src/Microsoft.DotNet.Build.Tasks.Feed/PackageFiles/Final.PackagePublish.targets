<Project ToolsVersion="12.0" DefaultTargets="PublishFinalPackages" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!--
    Using a completed orchestrated build's output manifest on dotnet/versions, publish its packages
    to final endpoints.
  -->
  <Target Name="PublishFinalPackages"
          DependsOnTargets="FetchOrchestratedBuildManifestInfo;
                            DownloadOrchestratedFeedPackages;
                            PublishFinalPackagesToMyGet;
                            PublishFinalPackagesToCentralBlobFeed;
                            CreateFinalPackagePublishSemaphore;
                            UpdateOrchestratedBuildManifest" />

  <Target Name="PrepareFinalPackagesToMyGet">
    <Error Text="The MyGetDotNetCoreApiKey property must be set." Condition="'$(MyGetDotNetCoreApiKey)' == ''" />

    <ItemGroup>
      <PackagesToPush Include="@(DownloadedOrchestratedFeedPackages)" />
    </ItemGroup>

    <PropertyGroup>
      <MyGetDotNetCoreBaseEndpoint Condition="'$(MyGetDotNetCoreBaseEndpoint)' == ''">https://dotnet.myget.org/F/dotnet-core</MyGetDotNetCoreBaseEndpoint>
      <MyGetDotNetCorePushEndpoint Condition="'$(MyGetDotNetCorePushEndpoint)' == ''">$(MyGetDotNetCoreBaseEndpoint)/api/v2/package</MyGetDotNetCorePushEndpoint>
      <MyGetDotNetCoreRestoreEndpoint Condition="'$(MyGetDotNetCoreRestoreEndpoint)' == ''">$(MyGetDotNetCoreBaseEndpoint)/api/v3/index.json</MyGetDotNetCoreRestoreEndpoint>

      <!-- Configuration for the 'NuGetPush' target. -->
      <NuGetSource>$(MyGetDotNetCorePushEndpoint)</NuGetSource>
      <NuGetApiKey>$(MyGetDotNetCoreApiKey)</NuGetApiKey>
    </PropertyGroup>
  </Target>

  <Target Name="PublishFinalPackagesToMyGet"
          DependsOnTargets="PrepareFinalPackagesToMyGet;NuGetPush"
          Condition="'$(SkipMyGetPublish)' != 'true'">
    <ItemGroup>
      <ManifestUpdates Include="PublishFinalPackagesToMyGet">
        <UpdateType>AddOrMergeEndpoint</UpdateType>
        <Xml><![CDATA[<Endpoint Id="dotnet.myget.org dotnet-core" Type="NuGetFeed" Url="$(MyGetDotNetCoreRestoreEndpoint)">@(FinalPackages -> '%(Xml)', '')</Endpoint>]]></Xml>
      </ManifestUpdates>
    </ItemGroup>
  </Target>

  <Target Name="PublishFinalPackagesToCentralBlobFeed"
          Condition="'$(SkipCentralBlobFeedPublish)' != 'true'">
    <PushToBlobFeed ExpectedFeedUrl="$(CentralBlobFeedUrl)"
                    AccountKey="$(AccountKey)"
                    ItemsToPush="@(DownloadedOrchestratedFeedPackages)"
                    Overwrite="$(OverwriteCentralBlobFeed)" />

    <ItemGroup>
      <ManifestUpdates Include="PublishFinalPackagesToCentralBlobFeed">
        <UpdateType>AddOrMergeEndpoint</UpdateType>
        <Xml><![CDATA[<Endpoint Id="CentralBlobFeed" Type="BlobFeed" Url="$(CentralBlobFeedUrl)">@(FinalPackages -> '%(Xml)', '')</Endpoint>]]></Xml>
      </ManifestUpdates>
    </ItemGroup>
  </Target>

  <Target Name="CreateFinalPackagePublishSemaphore">
    <ItemGroup>
      <SemaphoreNames Include="packages.semaphore" />
    </ItemGroup>
  </Target>
</Project>
